#!/bin/bash
set -euo pipefail

# Description:
# Launch a programm into a Kitty window.
#
# Usage:
# klaunch [--width=X] [--height=Y] [--bg='#xxxxxx'] [--fg='#yyyyyy'] [any_kitty_opt] -- COMMAND ...
#
# Examples:
# klaunch -- htop
# klaunch --width=1000 --height=500 -- htop
# klaunch -o window_padding_width=30 -- htop

# Default values
width=500
height=800
bg='#1e293b'
fg='#c5d4fc'

KITTY_OPT=()

# Options
while [[ $# -gt 0 && $1 != '--' ]]; do
    case $1 in
        --width=*)
            width="${1#*=}"
            shift
            ;;
        --height=*)
            height="${1#*=}"
            shift
            ;;
        --bg=*)
            bg="${1#*=}"
            shift
            ;;
        --fg=*)
            fg="${1#*=}"
            shift
            ;;
        *)
            KITTY_OPT+=("$1")
            shift
            ;;
    esac
done

if [[ $# -eq 0 ]]; then
    echo 'ERROR: klaunch options and command must be separated by "--". Example: "klaunch -- htop"'
    exit 1
fi

# Shift the remaining '--' token
shift

# Primary monitor resolution
primary_monitor_resolution="$(xrandr | grep -oE 'primary [0-9]+x[0-9]+' | awk '{ print $2 }')"
primary_monitor_width="${primary_monitor_resolution%x*}"
primary_monitor_height="${primary_monitor_resolution#*x}"

# Center window
x_position=$(((primary_monitor_width-width)/2))
y_position=$(((primary_monitor_height-height)/2))

# Fire command
kitty \
    -o "initial_window_width=${width}" \
    -o "initial_window_height=${height}" \
    -o "background=${bg}" \
    -o "foreground=${fg}" \
    -o 'hide_window_decorations yes' \
    -o 'window_padding_width=10' \
    --position="${x_position}x${y_position}" \
    "${KITTY_OPT[@]}" \
    -- \
    "$@"
