#!/bin/bash
set -euo pipefail

# sync configuration from bareconfig to a list of remote hosts
# You should exchange keys with all the remote hosts for better experience

# user for host machine
user="$1"
# file with one host by line
hostList="$2"

function safesync {
    local user="$1"
    local host="$2"
    local object="$3"

    local dest
    dest=$(dirname "${object}")

    if [[ -d ${object} ]]; then
        echo -e "\nINFO: sync directory ${object} to ${user}@${host}:${dest}/"
        rsync -arvh --delete "${object}" "${user}"@"${host}":"${dest}/"
    elif [[ -f ${object} ]]; then
        echo -e "\nINFO: sync file ${object} to ${user}@${host}:${dest}/"
        rsync -avh "${object}" "${user}"@"${host}":"${dest}/"
    else
        echo "INFO: ${object} does not exist or is not readable."
    fi
}

while IFS= read -r host; do
    echo -e "\n# ${host}"
    safesync "$user" "$host" "$HOME/.profile"
    safesync "$user" "$host" "$HOME/.bash_profile"
    safesync "$user" "$host" "$HOME/.vim"
    safesync "$user" "$host" "$HOME/.config/shell"
    safesync "$user" "$host" "$HOME/.bashrc"
    safesync "$user" "$host" "$HOME/.config/bash"
done < "${hostList}"
