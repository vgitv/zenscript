#!/bin/bash
set -euo pipefail

# Autocommit and push to repository, when commit description is not important.
# Usage:
# autocommit


function log {
    echo "autocommit: $*"
}


last_commit_msg="$(git log -n 1 --format=format:'%s')"
last_commit_day="$(git log -n 1 --format=format:'%as')"
current_day="$(date -Idate)"
autocommit_msg='Autocommit'

git add "$(git rev-parse --show-toplevel)"

if git status --porcelain | grep -qE '.'; then
    if [[ ${last_commit_msg} = 'Autocommit' && ${current_day} = "${last_commit_day}" ]]; then
        log 'Amend last autocommit'
        git commit -m "$autocommit_msg" --amend --allow-empty
        log 'Force push commit'
        git push -f
    else
        log 'Create a new autocommit'
        git commit -m "$autocommit_msg"
        log 'Push commit'
        git push
    fi
else
    log 'Nothing to do'
fi
